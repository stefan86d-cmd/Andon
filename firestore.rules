rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function getUserRole(userId) {
      return getUserData(userId).role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    function isSupervisor() {
      return isSignedIn() && (getUserRole(request.auth.uid) == 'supervisor' || isAdmin());
    }
    
    function isOperator() {
        return isSignedIn() && getUserRole(request.auth.uid) == 'operator';
    }
    
    function isSameOrg(newUserEmail) {
      let adminEmail = getUserData(request.auth.uid).email;
      return adminEmail.split('@')[1] == newUserEmail.split('@')[1];
    }

    // Collection: users
    // - Admins can read and write any user document.
    // - Any authenticated user can read their own document.
    // - Only admins from the same organization can create users.
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow write: if isAdmin();
      allow create: if isAdmin() && isSameOrg(request.resource.data.email);
      allow delete: if isAdmin();
    }

    // Collection: issues
    // - Admins and Supervisors can read all issues.
    // - Operators can read issues on their assigned production line.
    // - Authenticated users can create new issues.
    // - Admins and Supervisors can update issues.
    match /issues/{issueId} {
      allow read: if isSupervisor() || (isOperator() && resource.data.productionLineId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.productionLineId);
      allow create: if isSignedIn();
      allow update: if isSupervisor();
      allow delete: if isAdmin();
    }

    // Collection: productionLines
    // - All authenticated users can read production line data (needed for issue reporting).
    // - Only Admins can create, update, or delete production lines.
    match /productionLines/{lineId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
